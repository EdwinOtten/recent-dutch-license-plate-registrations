<!DOCTYPE html>
<html>

  <head>
    <title>Kentekenregistraties</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
      #urlOutput {
        margin-top: 20px;
      }

      .table-responsive {
        overflow-x: auto;
      }

    </style>
  </head>

  <body>
    <div class="container mt-5">
      <h1 class="mb-4">KIA Sportage kentekenregistraties</h1>
      <div class="form-group">
        <label for="make">Merk:</label>
        <select class="form-control" id="make" name="make" disabled>
          <option value="KIA">KIA</option>
        </select>
      </div>
      <div class="form-group">
        <label for="model">Model:</label>
        <select class="form-control" id="model" name="model" disabled>
          <option value="SPORTAGE">SPORTAGE</option>
        </select>
      </div>
      <div class="form-group">
        <label for="bpm">BPM:</label>
        <input type="number" class="form-control" id="bpm" name="bpm" value="6933" />
      </div>
      <div class="form-group">
        <label for="catalogusprijs">catalogusprijs:</label>
        <input type="number" class="form-control" id="catalogusprijs" name="catalogusprijs" value="46575" />
      </div>
      <div class="form-group">
        <label for="color">Kleur:</label>
        <select class="form-control" id="color" name="color">
          <option>GROEN</option>
          <option>BLAUW</option>
          <option>GRIJS</option>
          <option>ZWART</option>
          <option>WIT</option>
          <option>GEEL</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="loadRegistrations()">Zoek registraties</button>
      <button class="btn" onclick="showUrl()">Generate URL</button>
      <code id="urlOutput" class="mt-4"></code>

      <h2 class="mt-5">Resultaten</h2>
      <blockquote id="result-text">
      </blockquote>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Kenteken</th>
            <th>Merk</th>
            <th>Handelsbenaming</th>
            <th>Datum Tenaamstelling</th>
            <th>Bruto BPM</th>
            <th>Eerste Kleur</th>
            <th>Max Trekgewicht Geremd</th>
            <th>Catalogusprijs</th>
            <th>Max Snelheid</th>
            <th>Type</th>
            <th>Typegoedkeuringsnummer</th>
            <th>Variant</th>
            <th>Uitvoering</th>
            <th>Vermogen Massarijklaar</th>
            <th>Registratiedatum Goedkeuring</th>
          </tr>
        </thead>
        <tbody id="vehicle-table-body">
          <!-- Data will be inserted here -->
        </tbody>
      </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
      const baseUrl = 'https://opendata.rdw.nl/resource/m9d7-ebf2.json'

      const daysAgo = 14
      const d = new Date()
      d.setDate(d.getDate() - daysAgo);
      const startDate = d.toISOString().slice(0, 10).replace(/-/g, "")
      console.log('Finding car registrations since ' + startDate)

      function generateUrl() {
        var make = document.getElementById('make').value;
        var model = document.getElementById('model').value;
        var bpm = document.getElementById('bpm').value;
        var catalogusprijs = document.getElementById('catalogusprijs').value;
        var color = document.getElementById('color').value;

        var query = `SELECT
  kenteken,
  merk,
  handelsbenaming,
  datum_tenaamstelling,
  bruto_bpm,
  eerste_kleur,
  maximum_trekken_massa_geremd,
  catalogusprijs,
  maximale_constructiesnelheid,
  type,
  typegoedkeuringsnummer,
  variant,
  uitvoering,
  vermogen_massarijklaar,
  registratie_datum_goedkeuring_afschrijvingsmoment_bpm_dt
WHERE
  caseless_eq(merk, "` + make + `")
  AND (caseless_eq(handelsbenaming, "` + model + `")
         AND ((datum_tenaamstelling >= '` + startDate + `')
                AND (caseless_eq(eerste_kleur, "` + color + `")
                       AND ((bruto_bpm = ` + bpm + `)
                              AND (catalogusprijs = ` + catalogusprijs + `)))))
ORDER BY datum_tenaamstelling DESC NULL LAST`

        return baseUrl + '?$query=' + encodeURIComponent(query)
      }

      function showUrl() {
        const url = generateUrl()
        document.getElementById('urlOutput').innerHTML = '<a href="' + url + '">' + url + '</a>'
      }

      function loadRegistrations() {
        const url = generateUrl()
        fetch(url)
          .then(processResponse)
          .then(displayResults)
      }

      function processResponse(response) {
        if (response.status === 200) {
          return response.json()
        } else {
          alert('Fout bij het opbalen van gegevens van RDW API. Status code: ' + response.status)
          console.error('response body', response.text())
        }
      }

      function displayResults(cars) {
        let tableContent = '';
        cars.forEach(function(car) {
          tableContent += '<tr>';
          for (let key in car) {
            tableContent += '<td>' + car[key] + '</td>';
          }
          tableContent += '</tr>';
        });
        $('#vehicle-table-body').html(tableContent);
        $('#result-text').html('In de afgelopen ' + daysAgo + ' dagen zijn er ' + cars.length + ' nieuwe KIA\'s op kenteken gezet met deze configuratie.');
      }

    </script>
  </body>

</html>
